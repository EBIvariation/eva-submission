<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-stream="http://www.springframework.org/schema/integration/stream"
       xmlns:int-http="http://www.springframework.org/schema/integration/http"
       xmlns:int-file="http://www.springframework.org/schema/integration/file"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/integration/stream http://www.springframework.org/schema/integration/stream/spring-integration-stream.xsd
		http://www.springframework.org/schema/integration/http http://www.springframework.org/schema/integration/http/spring-integration-http.xsd
		http://www.springframework.org/schema/integration/file	http://www.springframework.org/schema/integration/file/spring-integration-file.xsd">

    <int:channel id="channelIntoDownloadFastaENA"/>
    <int:channel id="channelOutGetChromAccsSplit"/>

    <bean id="sequenceReportProcessor" class="embl.ebi.variation.eva.sequence_report_processing.SequenceReportProcessor"/>

    <int:chain input-channel="channelIntoDownloadFastaENA" output-channel="channelOutGetChromAccsSplit">
        <!--Get chromosome accessions from sequence report file-->
        <int:transformer ref="sequenceReportProcessor" method="getChromosomeAccessions"/>
        <!--Split chromosome accessions into one message per accession-->
        <int:splitter />
    </int:chain>

    <!--<int-stream:stdout-channel-adapter channel="channelOutGetChromAccsSplit" append-newline="true"/>-->

    <int:channel id="enaFastaReply">
        <!--<int:queue capacity="3"/>-->
    </int:channel>

    <int-http:outbound-gateway
            request-channel="channelOutGetChromAccsSplit"
            reply-channel="enaFastaReply"
            url="https://www.ebi.ac.uk/ena/data/view/{chromAcc}&amp;display=fasta"
            http-method="GET"
            expected-response-type="java.lang.String">
        <int-http:uri-variable name="chromAcc" expression="payload"/>
    </int-http:outbound-gateway>

    <int-file:outbound-gateway request-channel="enaFastaReply"
                               directory="/home/tom/Job_Working_Directory/Java/eva-integration/src/main/resources/test_dl/ftpInbound"
                               mode="APPEND"
                               filename-generator-expression="@environment.getProperty('assembly.accession')+'.fasta'"
                               reply-channel="nullChannel"

    >
        <!--http://stackoverflow.com/questions/16351668/compression-and-decompression-of-string-data-in-java-->
    </int-file:outbound-gateway>

</beans>