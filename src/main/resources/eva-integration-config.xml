<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-ftp="http://www.springframework.org/schema/integration/ftp"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:int-stream="http://www.springframework.org/schema/integration/stream"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
		http://www.springframework.org/schema/integration/ftp http://www.springframework.org/schema/integration/ftp/spring-integration-ftp.xsd
        http://www.springframework.org/schema/integration/stream http://www.springframework.org/schema/integration/stream/spring-integration-stream.xsd">

    <context:property-placeholder location="classpath:user.properties"/>

    <!--<import resource="classpath:connection-config.xml"/>-->

    <!--Client factory to create connection to ftp-->
    <bean id="ftpClientFactory"
          class="org.springframework.integration.ftp.session.DefaultFtpSessionFactory">
        <property name="host" value="${host}"/>
        <!--<property name="port" value="${availableServerPort}"/>-->
        <property name="username" value="${userid}"/>
        <property name="password" value="${password}"/>
    </bean>

    <!--<int-stream:stdout-channel-adapter append-newline="true" channel="transformedChannel"/>-->

    <!--Channel to receive input, at the moment the input is to the directory-->
    <int:channel id="inputChannel"/>

    <!--Recursively lists files from directory given in inputChannel-->
    <int-ftp:outbound-gateway id="lsSequenceReports"
                              session-factory="ftpClientFactory"
                              request-channel="inputChannel"
                              command="ls"
                              command-options="-1 -R"
                              expression="payload"
                              reply-channel="intoChainChannel"
    />

    <int:channel id="outOfChainChannel"/>

    <bean id="sequenceReportPathTransformer" class="embl.ebi.variation.eva.SequenceReportPathTransformer"/>
    
    <int:chain input-channel="intoChainChannel" output-channel="outOfChainChannel">
        <!--Splitter splits ls results into individual files-->
        <int:splitter id="splitter"/>
        <!--Filter finds sequence report file-->
        <int:filter expression="payload.matches('[\w\/]*${assembly.accession}_sequence_report.txt')"/>
        <!--Transforms message from filter. Uses payload (filename) and directory path from header. Outputs absolute remote file path-->
        <int:transformer ref="sequenceReportPathTransformer" method="transform"/>
    </int:chain>

    <int:channel id="outputChannel">
        <int:queue capacity="1"/>
    </int:channel>

    <!--Gets the sequence report file-->
    <int-ftp:outbound-gateway session-factory="ftpClientFactory"
                              request-channel="outOfChainChannel"
                              command="get"
                              expression="payload"
                              local-directory="/home/tom/Job_Working_Directory/Java/eva-integration/src/main/resources/test_dl/ftpInbound"
                              reply-channel="outputChannel"
                              auto-create-local-directory="true"
    />
</beans>
