<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-ftp="http://www.springframework.org/schema/integration/ftp"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:int-stream="http://www.springframework.org/schema/integration/stream"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
		http://www.springframework.org/schema/integration/ftp http://www.springframework.org/schema/integration/ftp/spring-integration-ftp.xsd
        http://www.springframework.org/schema/integration/stream http://www.springframework.org/schema/integration/stream/spring-integration-stream.xsd">

    <!--Channel to receive input, at the moment the input is to the directory-->
    <int:channel id="channelIntoSeqReportDl"/>

    <!--Recursively lists files from directory given in inputChannel-->
    <int-ftp:outbound-gateway id="lsSequenceReports"
                              session-factory="ftpClientFactory"
                              request-channel="channelIntoSeqReportDl"
                              command="ls"
                              command-options="-1 -R"
                              expression="payload"
                              reply-channel="channelIntoSeqRepDlChain"
    />

    <int:channel id="channelOutSeqRepDlChain"/>

    <bean id="sequenceReportPathTransformer" class="embl.ebi.variation.eva.sequence_report_download.SequenceReportPathTransformer"/>
    
    <int:chain input-channel="channelIntoSeqRepDlChain" output-channel="channelOutSeqRepDlChain">
        <!--Splitter splits ls results into individual files-->
        <int:splitter id="splitter"/>
        <!--Filter finds sequence report file-->
        <int:filter expression="payload.matches('[\w\/]*${assembly.accession}_sequence_report.txt')"/>
        <!--Transforms message from filter. Uses payload (filename) and directory path from header. Outputs absolute remote file path-->
        <int:transformer ref="sequenceReportPathTransformer" method="transform"/>
    </int:chain>

    <!--Gets the sequence report file-->
    <int-ftp:outbound-gateway session-factory="ftpClientFactory"
                              request-channel="channelOutSeqRepDlChain"
                              command="get"
                              expression="payload"
                              local-directory="/home/tom/Job_Working_Directory/Java/eva-integration/src/main/resources/test_dl/ftpInbound"
                              reply-channel="channelIntoDownloadFastaENA"
                              auto-create-local-directory="true"
    />

</beans>
