import datetime
import unittest
from unittest.mock import patch, PropertyMock

import pytest
from more_itertools.more import side_effect
from sqlalchemy import create_engine

from eva_submission.evapro.load_from_ena import EnaProjectLoader
from eva_submission.evapro.table import metadata

all_projects = ['PRJEB10956','PRJEB10964','PRJEB11471','PRJEB11745','PRJEB11746','PRJEB11749','PRJEB11750','PRJEB11984','PRJEB12769','PRJEB12770','PRJEB12771','PRJEB13080','PRJEB13081','PRJEB13082','PRJEB13083','PRJEB13084','PRJEB13085','PRJEB13086','PRJEB13087','PRJEB13088','PRJEB13089','PRJEB13090','PRJEB13516','PRJEB13517','PRJEB13618','PRJEB13625','PRJEB14018','PRJEB14378','PRJEB14385','PRJEB14684','PRJEB14685','PRJEB14713','PRJEB14878','PRJEB14879','PRJEB15197','PRJEB15384','PRJEB15385','PRJEB15642','PRJEB17529','PRJEB18671','PRJEB19387','PRJEB19523','PRJEB19524','PRJEB19794','PRJEB20009','PRJEB20726','PRJEB20817','PRJEB20820','PRJEB21300','PRJEB21794','PRJEB21914','PRJEB22189','PRJEB22261','PRJEB22799','PRJEB22833','PRJEB22866','PRJEB22988','PRJEB22989','PRJEB23068','PRJEB23188','PRJEB23201','PRJEB23301','PRJEB23437','PRJEB23441','PRJEB23487','PRJEB23749','PRJEB23751','PRJEB23791','PRJEB23828','PRJEB23844','PRJEB24044','PRJEB24066','PRJEB24306','PRJEB24328','PRJEB24624','PRJEB24630','PRJEB24746','PRJEB24747','PRJEB24756','PRJEB24763','PRJEB24783','PRJEB24835','PRJEB24930','PRJEB24944','PRJEB24964','PRJEB24974','PRJEB24995','PRJEB24997','PRJEB25004','PRJEB25439','PRJEB25656','PRJEB25731','PRJEB25807','PRJEB25808','PRJEB25899','PRJEB25965','PRJEB26285','PRJEB26328','PRJEB26337','PRJEB26368','PRJEB26477','PRJEB26543','PRJEB26741','PRJEB26751','PRJEB26962','PRJEB26970','PRJEB27093','PRJEB27150','PRJEB27177','PRJEB27233','PRJEB27278','PRJEB27312','PRJEB2733','PRJEB27381','PRJEB27427','PRJEB27431','PRJEB27443','PRJEB27452','PRJEB27676','PRJEB27771','PRJEB27789','PRJEB27824','PRJEB27956','PRJEB28064','PRJEB28236','PRJEB28258','PRJEB28260','PRJEB28297','PRJEB28302','PRJEB28306','PRJEB28344','PRJEB28526','PRJEB28530','PRJEB28547','PRJEB28557','PRJEB28579','PRJEB28591','PRJEB28606','PRJEB28702','PRJEB28797','PRJEB28835','PRJEB28874','PRJEB28956','PRJEB29080','PRJEB29251','PRJEB29344','PRJEB29384','PRJEB29523','PRJEB29561','PRJEB29597','PRJEB29734','PRJEB29974','PRJEB29975','PRJEB30080','PRJEB30116','PRJEB30122','PRJEB3025','PRJEB3027','PRJEB30318','PRJEB3040','PRJEB3041','PRJEB3042','PRJEB30460','PRJEB30500','PRJEB30506','PRJEB30522','PRJEB30825','PRJEB30850','PRJEB31123','PRJEB31129','PRJEB31170','PRJEB31182','PRJEB31218','PRJEB31241','PRJEB31315','PRJEB31336','PRJEB31370','PRJEB31423','PRJEB31574','PRJEB31735','PRJEB31785','PRJEB31976','PRJEB32049','PRJEB32114','PRJEB32182','PRJEB32264','PRJEB32310','PRJEB32312','PRJEB32462','PRJEB32685','PRJEB32686','PRJEB32687','PRJEB32689','PRJEB32692','PRJEB32735','PRJEB32744','PRJEB32845','PRJEB32865','PRJEB32975','PRJEB33023','PRJEB33060','PRJEB33063','PRJEB33073','PRJEB33081','PRJEB33094','PRJEB33110','PRJEB33111','PRJEB33113','PRJEB33136','PRJEB33142','PRJEB33252','PRJEB33276','PRJEB33472','PRJEB33514','PRJEB33648','PRJEB33693','PRJEB33704','PRJEB33712','PRJEB33757','PRJEB33864','PRJEB33934','PRJEB33969','PRJEB34019','PRJEB34082','PRJEB34193','PRJEB34208','PRJEB34225','PRJEB34274','PRJEB34293','PRJEB34294','PRJEB34334','PRJEB34362','PRJEB34412','PRJEB34415','PRJEB34546','PRJEB34548','PRJEB34654','PRJEB34751','PRJEB34846','PRJEB35134','PRJEB35159','PRJEB35221','PRJEB35282','PRJEB35317','PRJEB35319','PRJEB35335','PRJEB35532','PRJEB35668','PRJEB35772','PRJEB35784','PRJEB35786','PRJEB36033','PRJEB36043','PRJEB36082','PRJEB36115','PRJEB36125','PRJEB36127','PRJEB36187','PRJEB36238','PRJEB36264','PRJEB36318','PRJEB36719','PRJEB36724','PRJEB36753','PRJEB36773','PRJEB36774','PRJEB36777','PRJEB36778','PRJEB36811','PRJEB36864','PRJEB36886','PRJEB36912','PRJEB37197','PRJEB37244','PRJEB37582','PRJEB37583','PRJEB37584','PRJEB37588','PRJEB37607','PRJEB37674','PRJEB37766','PRJEB37881','PRJEB37915','PRJEB38010','PRJEB38030','PRJEB38067','PRJEB38336','PRJEB38379','PRJEB38538','PRJEB38548','PRJEB38691','PRJEB38763','PRJEB38764','PRJEB38975','PRJEB39090','PRJEB39251','PRJEB39381','PRJEB39400','PRJEB39409','PRJEB39468','PRJEB39475','PRJEB39574','PRJEB39630','PRJEB39694','PRJEB39892','PRJEB39939','PRJEB40010','PRJEB40043','PRJEB40092','PRJEB40124','PRJEB4019','PRJEB40369','PRJEB40448','PRJEB40501','PRJEB40575','PRJEB40605','PRJEB40684','PRJEB40694','PRJEB40723','PRJEB40782','PRJEB40856','PRJEB40970','PRJEB40997','PRJEB41070','PRJEB41076','PRJEB41091','PRJEB41095','PRJEB41117','PRJEB41164','PRJEB41290','PRJEB41333','PRJEB41335','PRJEB41367','PRJEB41532','PRJEB41629','PRJEB4163','PRJEB41688','PRJEB41691','PRJEB41714','PRJEB41769','PRJEB41774','PRJEB41871','PRJEB41931','PRJEB41991','PRJEB42012','PRJEB42044','PRJEB42077','PRJEB42148','RJEB42246','PRJEB42374','PRJEB42376','PRJEB42411','PRJEB42419','PRJEB42472','PRJEB42486','PRJEB42513','PRJEB42529','PRJEB42554','PRJEB42581','PRJEB42582','PRJEB42670','PRJEB42783','PRJEB42835','PRJEB43053','PRJEB43127','PRJEB43233','PRJEB43243','PRJEB43246','PRJEB43298','PRJEB43318','PRJEB43394','PRJEB43548','PRJEB43675','PRJEB43696','PRJEB43721','PRJEB43764','PRJEB43837','PRJEB4395','PRJEB44201','PRJEB44264','PRJEB44269','PRJEB44301','PRJEB44378','PRJEB44390','PRJEB44446','PRJEB44478','PRJEB44569','PRJEB44672','PRJEB44734','PRJEB44876','PRJEB44901','PRJEB44918','PRJEB44919','PRJEB45041','PRJEB45075','PRJEB45235','PRJEB45238','PRJEB45429','PRJEB45547','PRJEB45554','PRJEB45759','PRJEB45841','PRJEB45961','PRJEB45988','PRJEB46068','PRJEB46073','PRJEB46183','PRJEB46209','PRJEB46210','PRJEB46414','PRJEB46458','PRJEB46486','PRJEB46494','PRJEB46861','PRJEB46968','PRJEB46970','PRJEB46983','PRJEB47268','PRJEB47270','PRJEB47290','PRJEB47332','PRJEB47529','PRJEB47695','PRJEB47787','PRJEB47801','PRJEB47822','PRJEB47912','PRJEB47913','PRJEB47918','PRJEB47999','PRJEB48002','PRJEB48005','PRJEB48125','PRJEB48128','PRJEB48200','PRJEB48356','PRJEB48438','PRJEB48592','PRJEB48602','PRJEB48632','PRJEB48736','PRJEB48950','PRJEB49103','PRJEB49104','PRJEB49105','PRJEB49106','PRJEB49107','PRJEB49108','PRJEB49109','PRJEB49110','PRJEB49193','PRJEB49213','PRJEB49292','PRJEB49380','PRJEB49407','PRJEB49958','PRJEB50053','PRJEB50175','PRJEB50333','PRJEB50475','PRJEB50521','PRJEB50764','PRJEB50808','PRJEB50815','PRJEB50888','PRJEB50889','PRJEB51000','PRJEB51003','PRJEB51008','PRJEB51024','PRJEB51091','PRJEB51100','PRJEB51117','PRJEB51505','PRJEB51528','PRJEB51612','PRJEB51718','PRJEB51724','PRJEB51774','PRJEB51826','PRJEB51851','PRJEB51858','PRJEB51904','PRJEB51919','PRJEB51961','PRJEB51985','PRJEB51993','PRJEB52220','PRJEB52348','PRJEB52445','PRJEB52471','PRJEB52511','PRJEB52597','PRJEB52611','PRJEB52628','PRJEB52694','PRJEB52700','PRJEB52759','PRJEB52893','PRJEB53039','PRJEB53221','PRJEB53236','PRJEB53276','PRJEB53351','PRJEB53442','PRJEB53443','PRJEB53507','PRJEB53593','PRJEB53725','PRJEB53894','PRJEB53906','PRJEB53985','PRJEB54072','PRJEB5439','PRJEB54689','PRJEB54712','PRJEB5472','PRJEB54721','PRJEB54891','PRJEB54897','PRJEB54935','PRJEB55008','PRJEB55077','PRJEB55177','PRJEB55183','PRJEB55239','PRJEB55295','PRJEB55326','PRJEB55345','PRJEB55355','PRJEB55361','PRJEB55391','PRJEB55519','PRJEB55549','PRJEB55550','PRJEB55561','PRJEB55654','PRJEB55655','PRJEB55814','PRJEB55868','PRJEB55993','PRJEB56038','PRJEB56092','PRJEB56161','PRJEB56210','PRJEB56211','PRJEB56315','PRJEB56316','PRJEB56398','PRJEB56438','PRJEB56443','PRJEB56445','PRJEB56472','PRJEB56549','PRJEB56751','PRJEB56753','PRJEB56780','PRJEB56869','PRJEB56888','PRJEB57234','PRJEB57237','PRJEB57400','PRJEB57548','PRJEB57550','PRJEB57636','PRJEB57696','PRJEB57722','PRJEB57750','PRJEB57851','PRJEB57852','PRJEB57879','PRJEB57993','PRJEB58052','PRJEB58188','PRJEB5828','PRJEB5829','PRJEB58296','PRJEB5850','PRJEB58559','PRJEB58641','PRJEB58644','PRJEB58778','PRJEB58829','PRJEB58836','PRJEB58895','PRJEB59022','PRJEB59041','PRJEB59193','PRJEB59227','PRJEB59266','PRJEB59353','PRJEB59363','PRJEB59419','PRJEB59423','PRJEB59438','PRJEB59561','PRJEB59574','PRJEB59596','PRJEB5966','PRJEB5967','PRJEB5971','PRJEB5978','PRJEB59909','PRJEB59912','PRJEB60100','PRJEB6024','PRJEB6025','PRJEB6033','PRJEB60339','PRJEB60368','PRJEB60396','PRJEB6040','PRJEB60406','PRJEB60409','PRJEB6041','PRJEB6042','PRJEB60428','PRJEB60441','PRJEB60477','PRJEB60498','PRJEB60506','PRJEB60508','PRJEB60512','PRJEB6057','PRJEB60575','PRJEB6058','PRJEB60875','PRJEB60906','PRJEB60907','PRJEB60909','PRJEB60948','PRJEB60949','PRJEB61053','PRJEB61055','PRJEB61080','PRJEB61081','PRJEB61107','PRJEB6119','PRJEB61195','PRJEB61209','PRJEB61260','PRJEB6135','PRJEB61387','PRJEB61407','PRJEB61408','PRJEB61514','PRJEB61601','PRJEB61663','PRJEB61743','PRJEB61781','PRJEB61786','PRJEB61878','PRJEB61880','PRJEB62099','PRJEB62133','PRJEB62157','PRJEB62420','PRJEB62432','PRJEB62522','PRJEB62681','PRJEB62782','PRJEB62846','PRJEB63072','PRJEB63147','PRJEB63154','PRJEB63191','PRJEB63330','PRJEB63376','PRJEB63402','PRJEB63626','PRJEB63638','PRJEB63644','PRJEB64024','PRJEB64027','PRJEB64213','PRJEB64281','PRJEB64325','PRJEB64467','PRJEB6450','PRJEB6451','PRJEB6452','PRJEB6453','PRJEB64774','PRJEB64885','PRJEB6495','PRJEB65007','PRJEB65017','PRJEB6506','PRJEB65096','PRJEB65578','PRJEB65579','PRJEB65581','PRJEB65722','PRJEB65760','PRJEB65875','PRJEB65949','PRJEB66172','PRJEB66286','PRJEB66288','PRJEB66341','PRJEB66443','PRJEB67281','PRJEB67343','PRJEB67562','PRJEB67630','PRJEB67727','PRJEB67728','PRJEB67908','PRJEB68332','PRJEB6902','PRJEB6911','PRJEB69292','PRJEB6930','PRJEB69688','PRJEB70024','PRJEB70402','PRJEB70403','PRJEB70515','PRJEB7061','PRJEB70773','PRJEB70778','PRJEB70957','PRJEB70960','PRJEB70965','PRJEB71339','PRJEB71347','PRJEB71453','PRJEB71638','PRJEB71647','PRJEB71753','PRJEB71833','PRJEB7217','PRJEB7218','PRJEB72553','PRJEB72639','PRJEB72796','PRJEB72805','PRJEB72817','PRJEB73349','PRJEB73350','PRJEB73569','PRJEB7378','PRJEB73790','PRJEB73817','PRJEB73845','PRJEB74211','PRJEB74212','PRJEB74317','PRJEB74470','PRJEB74477','PRJEB74481','PRJEB74512','PRJEB74565','PRJEB74769','PRJEB74924','PRJEB74935','PRJEB75222','PRJEB75238','PRJEB75654','PRJEB75736','PRJEB75934','PRJEB75966','PRJEB75981','PRJEB76301','PRJEB76874','PRJEB76921','PRJEB77006','PRJEB77007','PRJEB77089','PRJEB77093','PRJEB77193','PRJEB7723','PRJEB78357','PRJEB78435','PRJEB78483','PRJEB78511','PRJEB78551','PRJEB78817','PRJEB78836','PRJEB7894','PRJEB7895','PRJEB7898','PRJEB79130','PRJEB7923','PRJEB79236','PRJEB79357','PRJEB79359','PRJEB79361','PRJEB79400','PRJEB79788','PRJEB79890','PRJEB79895','PRJEB79928','PRJEB79929','PRJEB79945','PRJEB79966','PRJEB80000','PRJEB80026','PRJEB80157','PRJEB80159','PRJEB80165','PRJEB80328','PRJEB80485','PRJEB81219','PRJEB81411','PRJEB81716','PRJEB81721','PRJEB81786','PRJEB81859','PRJEB81861','PRJEB82205','PRJEB82242','PRJEB82246','PRJEB82346','PRJEB82347','PRJEB82500','PRJEB82503','PRJEB82556','PRJEB82671','PRJEB82679','PRJEB82692','PRJEB82720','PRJEB82721','PRJEB82793','PRJEB82834','PRJEB82836','PRJEB82995','PRJEB83454','PRJEB83571','PRJEB83663','PRJEB83688','PRJEB83806','PRJEB84062','PRJEB84361','PRJEB84388','PRJEB85239','PRJEB85531','PRJEB85628','PRJEB85629','PRJEB85638','PRJEB8636','PRJEB8639','PRJEB8650','PRJEB8652','PRJEB8661','PRJEB8705','PRJEB9373','PRJEB9507','PRJEB9586','PRJEB9656','PRJEB9799','PRJEB9822','PRJEB9857','PRJEB9858','PRJEBZ0001','PRJNA273563','PRJNA289433','PRJNA939025','PRJX00001']

class TestLoadFromENA(unittest.TestCase):

    def setUp(self):
        self.loader = EnaProjectLoader()

    def patch_evapro_engine(self, engine):
        metadata.create_all(engine)
        return patch.object(self.loader, '_evapro_engine', side_effect=PropertyMock(return_value=engine))


    @pytest.mark.skip('Needs access to ERA database')
    def test_find_project_from_ena_database(self):

        project = 'PRJEB36082'
        result = self.loader.find_project_from_ena_database(project)
        expected_results = ('ERP119220', 'PRJEB36082', 'ERA2336002',
                            'Shanghai Jiao Tong University Affiliated Sixth People’s Hospital', 'CTSK', 'Other',
                            datetime.datetime(2020, 1, 8, 11, 23, 31),
                            'CTSK gene polymorphism',  '9606', 'Homo sapiens', None, '')
        (study_id, project_accession, submission_id, center_name, project_alias, study_type, first_created,
        project_title, taxonomy_id, scientific_name, common_name, study_description) = result
        assert result == expected_results

    @pytest.mark.skip('Needs access to ERA database')
    def test_find_parent_project(self):
        project = 'PRJEB36082'
        expected_parent = 'PRJNA9558'
        assert self.loader.find_parent_project(project) == expected_parent

    @pytest.mark.skip('Needs access to ERA database')
    def test_find_ena_submission(self):
        project = 'PRJEB66443'
        # for project in all_projects[700:800]:
        expected_actions = [
            ('ERA27275681', 'ELOAD_1194', datetime.datetime(2023, 9, 28, 15, 54, 7),
             {'type': 'ADD', 'schema': 'project', 'source': 'ELOAD_1194.Project.xml', 'hold_date': '2023-10-01'}),
            ('ERA27275681', 'ELOAD_1194', datetime.datetime(2023, 9, 28, 15, 54, 7),
             {'type': 'ADD', 'schema': 'analysis', 'source': 'ELOAD_1194.Analysis.xml', 'hold_date': '2023-10-01'})
        ]
        for project in [project]:
            submission_actions = list(self.loader.find_ena_submission(project))
            assert submission_actions == expected_actions

    @pytest.mark.skip('Needs access to ERA database')
    def test_find_analysis_in_ena(self):
        project = 'PRJEB25731'
        expected_analysis = [
            ('ERZ498176', 'Identification of a large SNP dataset in Larimichthys crocea', 'Lc-SNP',
             'The large yellow croaker, Larimichthys crocea is a commercially important drum fish (Family: Sciaenidae) native to the East and South China Sea. Habitat deterioration and overfishing have led to significant population decline and the collapse of its fishery over the past decades. In this study, we employed SLAF-seq (specific-locus amplified fragment sequencing) technology to identify single nucleotide polymorphism (SNP) loci across the genome of L. crocea. Sixty samples were selected for SLAF analysis out of 1,000 progeny in the same cohort of a cultured stock. Our analysis obtained a total of 151,253 SLAFs, of which 65.88% (99,652) were identified to be polymorphic, scoring a total of 710,567 SNPs. Further filtration resulted in a final panel of 1,782 SNP loci. The data derived from this work could be beneficial for understanding the genetics of complex phenotypic traits, as well as for developing marker selection-assisted breeding programs in the L. crocea aquaculture.',
             'SEQUENCE_VARIATION', 'Zhejiang Ocean University',
             datetime.datetime(2018, 3, 26, 15, 33, 35),
             'GCF_000972845.1', None, None, 'Whole genome sequencing', 'Illumina HiSeq 2500')
        ]
        assert list(self.loader.find_analysis_in_ena(project)) == expected_analysis

    @pytest.mark.skip('Needs access to ERA database')
    def test_find_samples_in_ena(self):
        analysis = 'ERZ23510811'
        expected_samples = [
            ('ERS18360856', 'SAMEA115348712'), ('ERS18360857', 'SAMEA115348713'), ('ERS18360858', 'SAMEA115348714'),
            ('ERS18360859', 'SAMEA115348715'), ('ERS18360860', 'SAMEA115348716'), ('ERS18360861', 'SAMEA115348717'),
            ('ERS18360862', 'SAMEA115348718'), ('ERS18360863', 'SAMEA115348719'), ('ERS18360864', 'SAMEA115348720'),
            ('ERS18360865', 'SAMEA115348721'), ('ERS18360866', 'SAMEA115348722'), ('ERS18360867', 'SAMEA115348723'),
            ('ERS18360868', 'SAMEA115348724'), ('ERS18360869', 'SAMEA115348725'), ('ERS18360870', 'SAMEA115348726'),
            ('ERS18360871', 'SAMEA115348727'), ('ERS18360872', 'SAMEA115348728'), ('ERS18360873', 'SAMEA115348729'),
            ('ERS18360874', 'SAMEA115348730'), ('ERS18360875', 'SAMEA115348731'), ('ERS18360876', 'SAMEA115348732'),
            ('ERS18360877', 'SAMEA115348733'), ('ERS18360878', 'SAMEA115348734'), ('ERS18360879', 'SAMEA115348735'),
            ('ERS18360880', 'SAMEA115348736'), ('ERS18360881', 'SAMEA115348737'), ('ERS18360882', 'SAMEA115348738'),
            ('ERS18360883', 'SAMEA115348739'), ('ERS18360884', 'SAMEA115348740'), ('ERS18360885', 'SAMEA115348741')
        ]
        results = list(self.loader.find_samples_in_ena(analysis))
        assert results == expected_samples


    @pytest.mark.skip('Needs access to ERA database')
    def test_find_files_in_ena(self):
        analysis = 'ERZ293539'
        results = list(self.loader.find_files_in_ena(analysis))
        expected_files = [
            ('ERZ293539', 'ERF11112570', 'IRIS_313-12319.snp.vcf.gz.tbi', 'b98e6396a38b1658d9e0116692e1dae3', 'TABIX', 4),
            ('ERZ293539', 'ERF11112569', 'IRIS_313-12319.snp.vcf.gz', '642b2e31ce4fc6b8c92eb2dc53630d47', 'VCF', 4)
        ]
        assert results == expected_files


    def test_load_project_from_ena(self):
        project = 'PRJEB66443'
        engine = create_engine("sqlite+pysqlite:///:memory:", echo=True, future=True)
        with self.patch_evapro_engine(engine):
            metadata.create_all(engine)
            self.loader.load_project_from_ena(project)
